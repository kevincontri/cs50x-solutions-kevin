{% extends "layout.html" %}

{% block title %}
    Patient Details
{% endblock %}

{% block body %}
    <div class="container my-4">
        <p><a href="/" class="btn btn-custom btn-glass" style="text-decoration: none;"> &lt; Homepage</a></p>
        <div class="patient-header">
            <h1> <i class="fa-solid fa-hospital-user"></i> Patient Details</h1>
            <h2>{{ patient.name }}</h2>
            <p>Age <span class="badge bg-primary">{{ patient.age }}</span></p>
        </div>
        <hr>
        {% if user.role == 'nurse' or user.role == 'admin'%}
            <div class="titles">
                <h3><i class="fa-solid fa-plus"></i>Add New Vital Signs</h3>
            </div>
            <div class="dashboard-header">
                <form action="/patients/{{ patient.id }}" method="post" class="container-fluid" onsubmit="disableSubmit(this)">
                    <input type="hidden" name="form_type" value="vitals">

                    <div class="row g-2">
                        <div class="col">
                            <input required class="form-control" type="number" placeholder="Systolic" name="systolic" min="10" max="250">
                        </div>
                        <div class="col">
                            <input required class="form-control" type="number" placeholder="Diastolic" name="diastolic" min="40" max="150">
                        </div>
                        <div class="col">
                            <input required class="form-control" type="number" placeholder="Heart Rate" name="heart_rate" min="30" max="220">
                        </div>
                        <div class="col">
                            <input required class="form-control" type="number" placeholder="Respiratory Rate" name="respiratory_rate" min="8" max="40">
                        </div>
                        <div class="col">
                            <input required class="form-control" type="number" placeholder="Oxygen Saturation" name="oxygen_saturation" min="50" max="100">
                        </div>
                        <div class="col">
                            <input required class="form-control" type="number" step="0.01" placeholder="Temperature" name="temperature" min="32.0" max="42.0">
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-custom w-50 mx-auto d-block btn-glass">Submit</button>
                    </div>
                </form>
            </div>
        {% endif %}
        <div class="titles">
            <h3><i class="fa-solid fa-heart-pulse"></i>Latest Vital Signs</h3>
        </div>
        {% if latest_vitals %}
            <table class="table table-striped table-hover table-glass">
                <tr>
                    <th>Systolic</th>
                    <th>Diastolic</th>
                    <th>Heart Rate</th>
                    <th>Respiratory Rate</th>
                    <th>Oxygen Saturation</th>
                    <th>Temperature</th>
                    <th>Recorded At</th>
                </tr>
                {% for sign in latest_vitals %}
                    <tr>
                        <td class="{% if sign.systolic > 140 or sign.systolic < 90%}text-danger fw-bold{% endif %}">
                            {{ sign.systolic }}
                        </td>

                        <td class="{% if sign.diastolic > 90 or sign.diastolic < 60 %}text-danger fw-bold{% endif %}">
                            {{ sign.diastolic }}
                        </td>

                        <td class="{% if sign.heart_rate < 55 or sign.heart_rate > 100 %}text-danger fw-bold{% endif %}">
                            {{ sign.heart_rate }}
                        </td>

                        <td class="{% if sign.respiratory_rate > 20 or sign.respiratory_rate < 12 %}text-danger fw-bold{% endif %}">
                            {{ sign.respiratory_rate }}
                        </td>

                        <td class="{% if sign.oxygen_saturation < 95 %}text-danger fw-bold{% endif %}">
                            {{ sign.oxygen_saturation }}
                        </td>

                        <td class="{% if sign.temperature > 37.3 or sign.temperature < 35 %}text-danger fw-bold{% endif %}">
                            {{ sign.temperature }}
                        </td>

                        <td>{{ sign.recorded_at }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <div class="alert alert-warning warning-alert-glass">
                <p>No latest vital signs for this patient!</p>
            </div>
        {% endif %}

        {% if user.role == 'doctor' or user.role == 'admin'%}
            <div class="titles">
                <h3><i class="fa-solid fa-triangle-exclamation"></i>Latest Abnormal Vital Signs</h3>
            </div>
            {% if alerts %}
                <div class="alert alert-danger danger-alert-glass">
                    <ul class="mb-0">
                        {% for alert in alerts %}
                            <li>{{ alert|title }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="alert alert-success success-alert-glass">
                    <p>No abnormalities in the latest vital signs or none registered yet</p>
                </div>
            {% endif %}
            <div class="titles">
                <h3><i class="fa-solid fa-vial"></i>Suggested Exams</h3>
            </div>
            {% if exams %}
                <div class="alert alert-warning warning-alert-glass">
                    <ul class="mb-0">
                        {% for exam in exams %}
                            <li>{{ exam }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="alert alert-success success-alert-glass">
                    <p>No suggested exams for this patient</p>
                </div>
            {% endif %}
        {% endif %}
        <div class="titles">
            <h3><i class="fa-solid fa-clock-rotate-left"></i>Vitals History</h3>
        </div>
        {% if vitals %}
            <table class="table table-striped table-hover table-glass">
                <tr>
                    <th>Systolic</th>
                    <th>Diastolic</th>
                    <th>Heart Rate</th>
                    <th>Respiratory Rate</th>
                    <th>Oxygen Saturation</th>
                    <th>Temperature</th>
                    <th>Recorded At</th>
                </tr>
                {% for vital in vitals %}
                    <tr>
                        <td class="{% if vital.systolic >= 140 or vital.systolic <= 90%}text-danger fw-bold{% endif %}">
                            {{ vital.systolic }}
                        </td>

                        <td class="{% if vital.diastolic >= 90 or vital.diastolic <= 60 %}text-danger fw-bold{% endif %}">
                            {{ vital.diastolic }}
                        </td>

                        <td class="{% if vital.heart_rate <= 55 or vital.heart_rate >= 100 %}text-danger fw-bold{% endif %}">
                            {{ vital.heart_rate }}
                        </td>

                        <td class="{% if vital.respiratory_rate >= 20 or vital.respiratory_rate <= 12 %}text-danger fw-bold{% endif %}">
                            {{ vital.respiratory_rate }}
                        </td>

                        <td class="{% if vital.oxygen_saturation <= 95 %}text-danger fw-bold{% endif %}">
                            {{ vital.oxygen_saturation }}
                        </td>

                        <td class="{% if vital.temperature >= 37.3 or vital.temperature <= 35 %}text-danger fw-bold{% endif %}">
                            {{ vital.temperature }}
                        </td>

                        <td>{{ vital.recorded_at }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <div class="alert alert-warning warning-alert-glass">
                <p>No vital signs recorded for this patient.</p>
            </div>
        {% endif %}
        <div class="titles">
            <h3><i class="fa-solid fa-notes-medical"></i>Notes</h3>
        </div>
        {% if notes %}
            <table class="table table-striped table-hover table-glass">
                <tr>
                    <th>Note</th>
                    <th>Signed by</th>
                    <th>Recorded_at</th>
                </tr>
                {% for note in notes %}
                    <tr>
                        <td>{{ note.content }}</td>
                        <td>{{ note.writer|title }}</td>
                        <td>{{ note.date_time }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <div class="alert alert-warning warning-alert-glass">
                <p>No recorded notes for this patient.</p>
            </div>
        {% endif %}
        <div class="titles">
            <h3><i class="fa-solid fa-pencil"></i>Create Note About Patient</h3>
        </div>
        <form action="/patients/{{ patient.id }}" method="POST" onsubmit="disableSubmit(this)">
            <input type="hidden" name="form_type" value="note">
            <textarea name="note" class="textarea-glass" autocomplete="off"></textarea><br>
            <button class="btn btn-custom btn-glass" type="submit">Submit</button>
        </form>

        {% if user.role == 'admin' %}

            <div class="titles">
                <h3>Change Patient Unit</h3>
                <form action="/admin" method="post" class="form-glass form-control">
                    <input type="hidden" name="form_type" value="change_patient_unit">
                    <input type="hidden" name="patient" value="{{ patient.id }}">
                    <input type="radio" name="unit" value="icu">
                    <label>ICU</label><br>

                    <input type="radio" name="unit" value="er">
                    <label>ER</label><br>

                    <input type="radio" name="unit" value="ward">
                    <label>Ward</label><br>

                    <input type="submit" class="btn btn-glass" value="Change Unit">
                </form>
            </div>

            <div class="titles">
                <h3><i class="fa-solid fa-user-xmark"></i>Discharge Patient From Hospital (Admins Only)</h3>
            </div>
            <form action="/admin" method="post" onsubmit="return confirm('Are you sure? This action cannot be undone.')">
                <input type="hidden" name="form_type" value="delete_patient">
                <input type="hidden" name="patient" value="{{ patient.id }}">
                <input type="submit" value="Discharge Patient" class="btn btn-custom danger-btn-glass">
            </form>
        {% endif %}

    </div>
{% endblock %}
